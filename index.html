<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>携号转网合约查询系统</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.core.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "微软雅黑", "Microsoft YaHei", sans-serif;
        }
        body {
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
            background: #f0f8ff;
            min-height: 100vh;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
        }
        .title {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            text-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .auth-status {
            font-size: 13px;
            color: #34495e;
        }
        .auth-status button {
            padding: 3px 8px;
            border: none;
            border-radius: 4px;
            background: #3498db;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
            margin-left: 5px;
            transition: background 0.2s;
        }
        .auth-status button:hover {
            background: #2980b9;
        }
        .search-box {
            background: #fff;
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.06);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }
        .search-box input {
            flex: 1;
            min-width: 250px;
            padding: 12px 15px;
            border: 1px solid #dce4ec;
            border-radius: 8px;
            font-size: 15px;
            outline: none;
            transition: all 0.3s;
        }
        .search-box input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .search-box button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            color: #fff;
            transition: all 0.3s;
        }
        .search-box button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .btn-search {
            background: #3498db;
        }
        .btn-reset {
            background: #95a5a6;
        }
        .btn-add {
            background: #2ecc71;
            display: none; /* 默认隐藏 */
        }
        .btn-export {
            background: #f39c12;
            display: none; /* 默认隐藏 */
        }
        .table-container {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.06);
            overflow-x: auto;
            will-change: transform;
            transform: translateZ(0);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
            table-layout: fixed; /* 固定表格布局，确保列宽生效 */
        }
        th, td {
            padding: 14px 10px;
            border: 1px solid #dce4ec;
            word-break: break-word;
            font-size: 14px;
            overflow: hidden;
        }
        /* 精准设置各列宽度（满足需求：序号/套餐分类等变窄，订购业务/取消流程变宽） */
        .col-id { width: 60px; } /* 序号 - 最窄 */
        .col-service { width: 300px; } /* 订购业务 - 最宽 */
        .col-type { width: 100px; } /* 套餐分类 - 窄 */
        .col-affect { width: 80px; } /* 影响携转 - 窄 */
        .col-cancelNow { width: 80px; } /* 可立即取消 - 窄 */
        .col-difficulty { width: 80px; } /* 取消难度 - 窄 */
        .col-process { width: 400px; } /* 取消流程 - 最宽 */

        th {
            background: #f8fafc;
            font-weight: bold;
            cursor: pointer;
            color: #2c3e50;
            transition: background 0.2s;
        }
        th:hover {
            background: #f1f5f9;
        }
        td {
            cursor: default;
            color: #34495e;
        }
        .admin-td {
            cursor: cell;
            transition: background 0.2s;
        }
        .admin-td.editable {
            outline: 2px solid #3498db;
            outline-offset: -1px;
            background: #f8fcff;
        }
        .highlight {
            background: #fffbeb;
            font-weight: 500;
            color: #d35400;
        }
        .tip {
            text-align: center;
            margin-top: 10px;
            font-size: 13px;
            display: none;
        }
        .save-tip {
            color: #2ecc71;
        }
        .export-tip {
            color: #f39c12;
        }
        .login-tip {
            color: #3498db;
        }
        .loading-tip {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 14px;
        }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin: 20px 0;
            padding: 12px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.06);
        }
        .pagination button {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            background: #3498db;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .pagination button:disabled {
            background: #dce4ec;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .pagination button:hover:not(:disabled) {
            background: #2980b9;
        }
        .pagination .page-num {
            padding: 8px 12px;
            border: 1px solid #dce4ec;
            border-radius: 8px;
            background: #fff;
            font-size: 14px;
            color: #34495e;
        }
        .pagination .page-num.active {
            background: #3498db;
            color: #fff;
            border-color: #3498db;
        }
        .pagination .page-info {
            font-size: 13px;
            color: #7f8c8d;
            margin: 0 10px;
        }
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
            will-change: opacity;
        }
        .login-box {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            width: 350px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        .login-box h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        .login-box input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid #dce4ec;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }
        .login-box input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .login-box button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: #3498db;
            color: #fff;
            font-size: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .login-box button:hover {
            background: #2980b9;
            opacity: 0.9;
        }
        .login-box .error-tip {
            color: #e74c3c;
            font-size: 12px;
            text-align: center;
            margin-bottom: 10px;
            display: none;
        }
        @media (max-width: 768px) {
            /* 移动端适配列宽，保证不拥挤 */
            .col-id { width: 40px; }
            .col-service { width: 150px; }
            .col-type { width: 70px; }
            .col-affect { width: 60px; }
            .col-cancelNow { width: 60px; }
            .col-difficulty { width: 60px; }
            .col-process { width: 200px; }

            th, td {
                padding: 10px 6px;
                font-size: 12px;
            }
            .search-box button {
                flex: 1 0 100%;
                padding: 10px 15px;
                font-size: 14px;
            }
            .search-box input {
                min-width: 100%;
            }
            .login-box {
                width: 90%;
                padding: 25px;
            }
            .title {
                font-size: 20px;
            }
            .pagination {
                flex-wrap: wrap;
                padding: 10px;
            }
            .pagination .page-info {
                width: 100%;
                text-align: center;
                margin-bottom: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- 头部：标题+权限状态 -->
    <div class="header">
        <div class="title">携号转网合约查询系统</div>
        <div class="auth-status" id="authStatus">
            当前身份：普通用户（仅查看/搜索）
            <button onclick="showLoginModal()">管理员登录</button>
        </div>
    </div>

    <!-- 搜索区域 -->
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="多关键词查询（空格分隔，如：5G 合约 是）">
        <button class="btn-search" onclick="searchData()">查询</button>
        <button class="btn-reset" onclick="resetData()">重置</button>
        <button class="btn-add" id="btnAdd" onclick="addRow()">新增数据</button>
        <button class="btn-export" id="btnExport" onclick="exportToExcel()">导出Excel</button>
    </div>

    <!-- 表格区域（修正多余符号，添加列宽类） -->
    <div class="table-container">
        <div class="loading-tip" id="loadingTip">数据加载中...</div>
        <table id="dataTable" style="display:none;">
            <thead>
                <tr>
                    <th class="col-id" onclick="sortTable(0)">序号</th>
                    <th class="col-service" onclick="sortTable(1)">订购业务</th>
                    <th class="col-type" onclick="sortTable(2)">套餐分类</th>
                    <th class="col-affect" onclick="sortTable(3)">影响携转</th>
                    <th class="col-cancelNow" onclick="sortTable(4)">可立即取消</th>
                    <th class="col-difficulty" onclick="sortTable(5)">取消难度</th>
                    <th class="col-process" onclick="sortTable(6)">取消流程</th>
                </tr>
            </thead>
            <tbody id="dataBody"></tbody>
        </table>
    </div>

    <!-- 翻页区域 -->
    <div class="pagination" id="pagination" style="display:none;">
        <button id="prevPage" onclick="changePage(currentPage - 1)" disabled>上一页</button>
        <div class="page-info" id="pageInfo">第 1 / 1 页</div>
        <div id="pageNumList" class="page-num-list"></div>
        <button id="nextPage" onclick="changePage(currentPage + 1)" disabled>下一页</button>
    </div>

    <!-- 提示信息 -->
    <div class="tip save-tip" id="saveTip">数据已保存成功！</div>
    <div class="tip export-tip" id="exportTip">Excel导出成功，正在下载...</div>
    <div class="tip login-tip" id="loginTip">管理员登录成功！已解锁全部操作权限</div>

    <!-- 管理员登录弹窗 -->
    <div class="login-modal" id="loginModal">
        <div class="login-box">
            <h3>管理员登录</h3>
            <div class="error-tip" id="loginError">账号或密码错误，请重试</div>
            <input type="text" id="adminUser" placeholder="请输入管理员账号" autocomplete="off">
            <input type="password" id="adminPwd" placeholder="请输入管理员密码" autocomplete="off">
            <button onclick="doLogin()">登录</button>
        </div>
    </div>

    <script>
        // 核心配置
        const CONFIG = {
            ADMIN: { username: "rongxuekeji", password: "6361301" },
            STORAGE_KEY: "numberPortabilityData",
            LOGIN_STATUS_KEY: "adminLoginStatus",
            PAGE_SIZE: 20,
            DEBOUNCE_TIME: 300,
            THROTTLE_TIME: 200
        };

        // 全局状态
        let isAdmin = false;
        let sortConfig = { col: 0, asc: true };
        let fullData = [];
        let currentPage = 1;
        let totalPages = 1;
        let filteredData = [];
        let debouncedSaveData = null;
        let throttledScrollLoad = null;

        // DOM元素缓存
        const DOM = (() => {
            const el = id => document.getElementById(id);
            return {
                searchInput: el("searchInput"),
                dataTable: el("dataTable"),
                dataBody: el("dataBody"),
                loadingTip: el("loadingTip"),
                saveTip: el("saveTip"),
                exportTip: el("exportTip"),
                loginTip: el("loginTip"),
                authStatus: el("authStatus"),
                btnAdd: el("btnAdd"),
                btnExport: el("btnExport"),
                loginModal: el("loginModal"),
                loginError: el("loginError"),
                adminUser: el("adminUser"),
                adminPwd: el("adminPwd"),
                pagination: el("pagination"),
                prevPage: el("prevPage"),
                nextPage: el("nextPage"),
                pageInfo: el("pageInfo"),
                pageNumList: el("pageNumList")
            };
        })();

        // 工具函数：防抖
        function debounce(fn, delay) {
            let timer = null;
            return function(...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        // 工具函数：节流
        function throttle(fn, interval) {
            let lastTime = 0;
            return function(...args) {
                const now = Date.now();
                if (now - lastTime >= interval) {
                    lastTime = now;
                    fn.apply(this, args);
                }
            };
        }

        // 页面初始化
        document.addEventListener("DOMContentLoaded", () => {
            debouncedSaveData = debounce(saveData, CONFIG.DEBOUNCE_TIME);
            throttledScrollLoad = throttle(() => {}, CONFIG.THROTTLE_TIME);
            
            checkLoginStatus();
            loadData();
            
            DOM.searchInput.addEventListener("keydown", e => e.key === "Enter" && searchData());
            DOM.loginModal.addEventListener("click", e => e.target === DOM.loginModal && closeLoginModal());
            DOM.dataBody.addEventListener("click", handleCellClick);
            DOM.dataBody.addEventListener("blur", handleCellBlur, true);
        });

        /** 权限控制 **/
        function checkLoginStatus() {
            const loginStatus = localStorage.getItem(CONFIG.LOGIN_STATUS_KEY);
            if (loginStatus === "true") {
                isAdmin = true;
                updateAdminPermission();
            }
        }

        function updateAdminPermission() {
            if (isAdmin) {
                DOM.btnAdd.style.display = "block";
                DOM.btnExport.style.display = "block";
                DOM.authStatus.innerHTML = `
                    当前身份：管理员（全部权限）
                    <button onclick="logoutAdmin()">退出登录</button>
                `;
            } else {
                DOM.btnAdd.style.display = "none";
                DOM.btnExport.style.display = "none";
                DOM.authStatus.innerHTML = `
                    当前身份：普通用户（仅查看/搜索）
                    <button onclick="showLoginModal()">管理员登录</button>
                `;
            }
            renderTable(getCurrentPageData());
            showTip(DOM.loginTip);
        }

        function doLogin() {
            const username = DOM.adminUser.value.trim();
            const password = DOM.adminPwd.value.trim();
            
            if (username === CONFIG.ADMIN.username && password === CONFIG.ADMIN.password) {
                isAdmin = true;
                localStorage.setItem(CONFIG.LOGIN_STATUS_KEY, "true");
                closeLoginModal();
                updateAdminPermission();
            } else {
                DOM.loginError.style.display = "block";
                setTimeout(() => DOM.loginError.style.display = "none", 2000);
            }
        }

        function logoutAdmin() {
            isAdmin = false;
            localStorage.removeItem(CONFIG.LOGIN_STATUS_KEY);
            updateAdminPermission();
        }

        function showLoginModal() {
            DOM.loginModal.style.display = "flex";
            DOM.loginError.style.display = "none";
            DOM.adminUser.value = "";
            DOM.adminPwd.value = "";
            DOM.adminUser.focus();
        }

        function closeLoginModal() {
            DOM.loginModal.style.display = "none";
        }

        /** 数据处理 **/
        function loadData() {
            const savedData = localStorage.getItem(CONFIG.STORAGE_KEY);
            const defaultData = [
                [1,"100GB咪咕业务定向流量包月（合约版）","定向流量包","是","否","中等","合约期内需联系10086人工客服协商解约，可能支付违约金；合约到期后可通过APP/短信取消"],
                [2,"10GB区域流量包（巴南）-24个月","区域流量包","是","否","中等","24个月合约期内不可直接取消，需联系客服申请提前终止并承担违约金"],
                [3,"1元20GB专属流量包-合约12个月（升级版）","专属流量包","是","否","中等","12个月合约期内无法直接取消，需通过10086或营业厅办理提前解约"],
                [4,"2023千兆叠加提速服务300M","提速服务","是","否","中等","若绑定宽带合约，需先解除宽带关联，再通过客服或营业厅取消"],
                [5,"2024承诺套尊享流量优惠-10GB-24个月","优惠流量包","是","否","中等","24个月承诺期内不可取消，需到期后或协商提前终止"],
                [6,"2024套餐升档流量升级-10GB","套餐升级包","否","是","低","通过中国移动APP“已订业务”板块直接取消，或发送对应取消指令到10086"],
                [7,"49元专属礼包（全国版）","营销礼包","是","否","中等","若包含合约期，需联系客服核实合约期限并协商解约"],
                [8,"5G服务","基础功能","否","是","低","通过APP或10086人工客服关闭5G功能开关即可"],
                [9,"5G福袋流量冲浪包15元档（首月1元）","流量包","否","是","低","通过中国移动APP“已订业务”取消，或发送短信指令到10086"],
                [10,"5G智享套餐（个人版）129元档","主套餐","是","否","高","需确认是否有合约期，合约期内解约需支付违约金；无合约可到营业厅或APP办理套餐变更"],
                [11,"8元4G飞享套餐（2023版）","主套餐","否","是","低","无合约限制，可通过10086客服或中国移动APP直接变更/取消"],
                [12,"安心包10元100MB（套外流量）","流量安心包","否","是","低","通过APP“已订业务”关闭，或发送短信QXAXB到10086"],
                [13,"超高清视频畅享包（6元）","视频权益包","否","是","低","发送短信QXCHQ到10086取消，或在APP“已订业务”中操作"],
                [14,"动感地带芒果卡-39元档（2024版）","主套餐","是","否","高","通常包含12个月合约期，合约内解约需支付剩余月租的30%作为违约金"],
                [15,"家庭网主卡（5元/月）","家庭业务","是","否","中等","需先解绑所有家庭成员，再通过10086客服或营业厅取消家庭网业务"],
                [16,"宽带电视融合套餐（100M）","融合套餐","是","否","高","需到营业厅办理拆机，若有合约期需支付违约金，同时退还光猫和机顶盒"],
                [17,"流量加餐包10元1GB","临时流量包","否","是","低","单次包无需取消，到期自动失效；包月包可通过APP或短信QXJCB到10086取消"],
                [18,"咪咕视频会员（15元/月）","会员权益包","否","是","低","在咪咕视频APP“我的会员”中取消自动续费，或发送QXMGHY到10086"],
                [19,"全球通银卡服务","会员服务","否","是","低","无合约，通过中国移动APP“全球通服务”板块取消，或联系10086客服"],
                [20,"任我用流量包20元2GB（包月）","包月流量包","否","是","低","发送短信QXRY20到10086取消，或在APP“已订业务”中操作"],
                [21,"手机邮箱免费版","增值服务","否","是","低","发送短信QXSYXY到10086取消，或在中国移动APP“增值业务”中关闭"],
                [22,"腾讯视频定向流量包15元/月","定向流量包","否","是","低","发送短信QXTXSP到10086取消，或在APP“已订业务”中操作"],
                [23,"孝心包10元/月（含亲情号）","亲情业务包","否","是","低","通过APP“家庭业务”解除亲情号绑定后，取消孝心包，或联系10086客服"],
                [24,"主副卡共享套餐（副卡3元/月）","副卡业务","是","否","中等","需先注销副卡，再通过营业厅或10086客服取消主副卡共享业务"]
            ];

            if (savedData) {
                fullData = JSON.parse(savedData);
            } else {
                fullData = defaultData.map((item, index) => ({
                    id: index + 1,
                    service: item[1],
                    type: item[2],
                    affect: item[3],
                    cancelNow: item[4],
                    difficulty: item[5],
                    process: item[6]
                }));
                saveData(fullData);
            }

            filteredData = [...fullData];
            calculateTotalPages();
            currentPage = 1;
            renderTable(getCurrentPageData());
            renderPagination();

            DOM.loadingTip.style.display = "none";
            DOM.dataTable.style.display = "table";
            DOM.pagination.style.display = "flex";
        }

        function calculateTotalPages() {
            totalPages = Math.ceil(filteredData.length / CONFIG.PAGE_SIZE) || 1;
        }

        function getCurrentPageData() {
            const startIndex = (currentPage - 1) * CONFIG.PAGE_SIZE;
            const endIndex = startIndex + CONFIG.PAGE_SIZE;
            return filteredData.slice(startIndex, endIndex);
        }

        // 渲染表格：保留批量插入优化，继承列宽类
        function renderTable(dataList) {
            const fragment = document.createDocumentFragment();
            dataList.forEach((item, index) => {
                const tr = document.createElement("tr");
                tr.setAttribute("data-index", (currentPage - 1) * CONFIG.PAGE_SIZE + index);
                
                const createTd = (content, isEditable = false, dataKey = "", colClass = "") => {
                    const td = document.createElement("td");
                    td.textContent = content;
                    if (colClass) td.classList.add(colClass);
                    if (isEditable && isAdmin) {
                        td.classList.add("admin-td");
                        td.setAttribute("data-key", dataKey);
                    }
                    return td;
                };

                tr.appendChild(createTd(item.id, false, "", "col-id"));
                tr.appendChild(createTd(item.service, true, "service", "col-service"));
                tr.appendChild(createTd(item.type, true, "type", "col-type"));
                tr.appendChild(createTd(item.affect, true, "affect", "col-affect"));
                tr.appendChild(createTd(item.cancelNow, true, "cancelNow", "col-cancelNow"));
                tr.appendChild(createTd(item.difficulty, true, "difficulty", "col-difficulty"));
                tr.appendChild(createTd(item.process, true, "process", "col-process"));

                fragment.appendChild(tr);
            });

            DOM.dataBody.innerHTML = "";
            DOM.dataBody.appendChild(fragment);

            const keywords = DOM.searchInput.value.trim().split(/\s+/).filter(k => k);
            if (keywords.length > 0) {
                highlightKeywords(keywords);
            }
        }

        function highlightKeywords(keywords) {
            const rows = DOM.dataBody.querySelectorAll("tr");
            rows.forEach(row => {
                const tds = row.querySelectorAll("td:not(.col-id)");
                tds.forEach(td => {
                    let text = td.textContent;
                    keywords.forEach(keyword => {
                        const reg = new RegExp(`(${keyword})`, "gi");
                        text = text.replace(reg, '<span class="highlight">$1</span>');
                    });
                    td.innerHTML = text;
                });
            });
        }

        function renderPagination() {
            DOM.pageInfo.innerHTML = `第 ${currentPage} / ${totalPages} 页（共 ${filteredData.length} 条数据）`;
            DOM.prevPage.disabled = currentPage === 1;
            DOM.nextPage.disabled = currentPage === totalPages;

            DOM.pageNumList.innerHTML = "";
            const pageRange = [];
            if (totalPages <= 5) {
                pageRange.push(...Array.from({ length: totalPages }, (_, i) => i + 1));
            } else {
                pageRange.push(1);
                if (currentPage > 3) pageRange.push("...");
                const start = Math.max(2, currentPage - 1);
                const end = Math.min(totalPages - 1, currentPage + 1);
                for (let i = start; i <= end; i++) pageRange.push(i);
                if (currentPage < totalPages - 2) pageRange.push("...");
                pageRange.push(totalPages);
            }

            pageRange.forEach(num => {
                if (num === "...") {
                    const span = document.createElement("span");
                    span.className = "page-num";
                    span.textContent = num;
                    DOM.pageNumList.appendChild(span);
                } else {
                    const btn = document.createElement("button");
                    btn.className = `page-num ${num === currentPage ? "active" : ""}`;
                    btn.textContent = num;
                    btn.onclick = () => changePage(num);
                    DOM.pageNumList.appendChild(btn);
                }
            });
        }

        function changePage(targetPage) {
            if (targetPage < 1 || targetPage > totalPages) return;
            currentPage = targetPage;
            renderTable(getCurrentPageData());
            renderPagination();
            DOM.dataTable.scrollIntoView({ behavior: "auto", block: "top" });
        }

        function saveData(dataList) {
            if (!isAdmin) return;
            localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(dataList));
            showTip(DOM.saveTip);
        }

        /** 单元格编辑 **/
        function handleCellClick(e) {
            const cell = e.target;
            if (cell.tagName !== "TD" || !cell.classList.contains("admin-td")) return;
            
            document.querySelectorAll(".admin-td.editable").forEach(td => {
                td.contentEditable = "false";
                td.classList.remove("editable");
            });
            
            cell.contentEditable = "true";
            cell.classList.add("editable");
            cell.focus();
        }

        function handleCellBlur(e) {
            const cell = e.target;
            if (cell.tagName !== "TD" || !cell.classList.contains("admin-td")) return;
            
            cell.contentEditable = "false";
            cell.classList.remove("editable");
            
            const rowIndex = parseInt(cell.parentElement.getAttribute("data-index"));
            const dataKey = cell.getAttribute("data-key");
            const newVal = cell.textContent.trim() || cell.textContent;

            if (fullData[rowIndex][dataKey] !== newVal) {
                fullData[rowIndex][dataKey] = newVal;
                filteredData[rowIndex][dataKey] = newVal;
                debouncedSaveData(fullData);
            }
        }

        /** 功能操作 **/
        function searchData() {
            const keywords = DOM.searchInput.value.trim().split(/\s+/).filter(k => k);

            filteredData = keywords.length === 0 
                ? [...fullData] 
                : fullData.filter(item => {
                    const itemStr = Object.values(item).join(" ").toLowerCase();
                    return keywords.every(key => itemStr.includes(key.toLowerCase()));
                });

            calculateTotalPages();
            currentPage = 1;
            renderTable(getCurrentPageData());
            renderPagination();
        }

        function resetData() {
            DOM.searchInput.value = "";
            filteredData = [...fullData];
            calculateTotalPages();
            currentPage = 1;
            renderTable(getCurrentPageData());
            renderPagination();
        }

        function addRow() {
            if (!isAdmin) return;
            const newRow = {
                id: fullData.length + 1,
                service: "请输入业务名称",
                type: "请输入套餐分类",
                affect: "是/否",
                cancelNow: "是/否",
                difficulty: "低/中/高",
                process: "请输入取消流程"
            };

            fullData.push(newRow);
            filteredData.push(newRow);
            debouncedSaveData(fullData);
            calculateTotalPages();
            currentPage = totalPages;
            renderTable(getCurrentPageData());
            renderPagination();

            const lastRow = DOM.dataBody.lastChild;
            if (lastRow) lastRow.querySelector(".admin-td").click();
        }

        function sortTable(col) {
            const sortKey = ["id", "service", "type", "affect", "cancelNow", "difficulty", "process"][col];
            sortConfig.asc = sortConfig.col === col ? !sortConfig.asc : true;
            sortConfig.col = col;

            filteredData.sort((a, b) => {
                let valA = a[sortKey];
                let valB = b[sortKey];
                
                if (sortKey === "id") {
                    return sortConfig.asc ? valA - valB : valB - valA;
                }
                
                valA = (valA + "").toLowerCase();
                valB = (valB + "").toLowerCase();
                return sortConfig.asc 
                    ? valA.localeCompare(valB, "zh-CN", { sensitivity: "base" })
                    : valB.localeCompare(valA, "zh-CN", { sensitivity: "base" });
            });

            if (isAdmin) {
                fullData = [...filteredData];
                debouncedSaveData(fullData);
            }

            calculateTotalPages();
            currentPage = 1;
            renderTable(getCurrentPageData());
            renderPagination();
        }

        function exportToExcel() {
            if (!isAdmin) return;
            const ws = XLSX.utils.json_to_sheet(fullData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "携号转网合约数据");

            const date = new Date();
            const fileName = `携号转网合约查询表_${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showTip(DOM.exportTip);
        }

        function showTip(tipElem) {
            tipElem.style.display = "block";
            setTimeout(() => tipElem.style.display = "none", 2500);
        }
    </script>
</body>
</html>
